generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  createdAt DateTime @default(now())

  deletedAt    DateTime?
  sessions     Session[]
  devices      Device[]
  entitlements Entitlement[]
  preferences  UserPreferences?
  accounts     Account[]
  transactions Transaction[]
  tickerPnlTotals TickerPnlTotal[]
  tickerPnlDaily  TickerPnlDaily[]
  wheelCycles     WheelCycle[]
  alertRules      AlertRule[]
  exportJobs      ExportJob[]
  brokerConnections BrokerConnection[]
  syncRuns         SyncRun[]
}

model Session {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  user             User     @relation(fields: [userId], references: [id])
  refreshTokenHash String   @unique
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  revokedAt        DateTime?

  @@index([userId])
}

model Device {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id])
  platform   String
  pushToken  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastSeenAt DateTime?

  @@unique([userId, pushToken])
}

model Entitlement {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  type      String
  status    String
  startedAt DateTime @default(now())
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
}

model UserPreferences {
  userId       String   @id @db.Uuid
  user         User     @relation(fields: [userId], references: [id])
  baseCurrency String   @default("USD")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AuthOtp {
  id           String   @id @default(uuid()) @db.Uuid
  email        String
  codeSalt     String
  codeHashHex  String
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  lastAttemptAt DateTime?
  ipAddress    String?

  @@index([email, createdAt])
}

model Account {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  user              User     @relation(fields: [userId], references: [id])
  brokerConnectionId String? @db.Uuid
  brokerConnection  BrokerConnection? @relation(fields: [brokerConnectionId], references: [id])
  externalAccountId String?
  name              String
  type              String
  baseCurrency      String   @default("USD")
  status            String
  raw               Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  positionSnapshots PositionSnapshot[]
  transactions      Transaction[]

  @@index([userId])
  @@unique([brokerConnectionId, externalAccountId])
}

model BrokerConnection {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @db.Uuid
  user               User     @relation(fields: [userId], references: [id])
  provider           String
  status             String
  externalUserId     String
  externalConnectionId String
  accessTokenEnc     Bytes?
  refreshTokenEnc    Bytes?
  scopes             String[]
  connectedAt        DateTime
  disconnectedAt     DateTime?
  lastSyncAt         DateTime?
  raw                Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  accounts Account[]
  syncRuns SyncRun[]

  @@index([userId])
  @@unique([provider, externalConnectionId])
}

model SyncRun {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  user             User     @relation(fields: [userId], references: [id])
  brokerConnectionId String @db.Uuid
  brokerConnection  BrokerConnection @relation(fields: [brokerConnectionId], references: [id])
  status           String
  startedAt        DateTime?
  finishedAt       DateTime?
  error            String?
  stats            Json?
  cursor           String?
  createdAt        DateTime @default(now())

  @@index([userId, createdAt])
  @@index([brokerConnectionId, createdAt])
}

model Instrument {
  id       String @id @default(uuid()) @db.Uuid
  type     String
  symbol   String?
  exchange String?
  currency String
  name     String?
  isin     String?
  raw      Json?

  optionContracts   OptionContract[]
  positionSnapshots PositionSnapshot[]
  transactions      Transaction[]

  @@index([symbol])
}

model OptionContract {
  id                   String     @id @default(uuid()) @db.Uuid
  underlyingInstrumentId String   @db.Uuid
  underlyingInstrument Instrument @relation(fields: [underlyingInstrumentId], references: [id])
  occSymbol             String    @unique
  expiry                DateTime  @db.Date
  strike                Decimal   @db.Decimal(20, 10)
  right                 String
  multiplier            Int       @default(100)
  currency              String
  raw                   Json?

  transactions Transaction[]

  @@index([underlyingInstrumentId])
}

model PositionSnapshot {
  accountId    String   @db.Uuid
  account      Account  @relation(fields: [accountId], references: [id])
  instrumentId String   @db.Uuid
  instrument   Instrument @relation(fields: [instrumentId], references: [id])

  asOf                 DateTime
  quantity             Decimal @db.Decimal(20, 10)
  avgCostAmountMinor   BigInt  @db.BigInt
  avgCostCurrency      String
  marketPriceAmountMinor BigInt? @db.BigInt
  marketPriceCurrency    String?
  marketValueAmountMinor BigInt? @db.BigInt
  marketValueCurrency    String?
  unrealizedPnlAmountMinor BigInt? @db.BigInt
  unrealizedPnlCurrency    String?
  raw                  Json?
  updatedAt            DateTime @updatedAt

  @@id([accountId, instrumentId])
  @@index([instrumentId])
}

model Transaction {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  user           User     @relation(fields: [userId], references: [id])
  accountId      String   @db.Uuid
  account        Account  @relation(fields: [accountId], references: [id])
  provider       String
  externalId     String
  executedAt     DateTime
  type           String
  instrumentId   String?  @db.Uuid
  instrument     Instrument? @relation(fields: [instrumentId], references: [id])
  optionContractId String? @db.Uuid
  optionContract   OptionContract? @relation(fields: [optionContractId], references: [id])
  wheelLegs        WheelLeg[]
  quantity       Decimal? @db.Decimal(20, 10)
  priceAmountMinor BigInt? @db.BigInt
  priceCurrency  String?
  grossAmountMinor BigInt? @db.BigInt
  feesAmountMinor BigInt? @db.BigInt
  feesCurrency   String?
  notes          String?
  raw            Json?
  createdAt      DateTime @default(now())

  @@unique([provider, accountId, externalId])
  @@index([userId, executedAt])
  @@index([accountId, executedAt])
  @@index([instrumentId])
  @@index([optionContractId])
}

model TickerPnlTotal {
  userId             String   @db.Uuid
  user               User     @relation(fields: [userId], references: [id])
  symbol             String
  baseCurrency       String
  realizedPnlMinor   BigInt   @db.BigInt
  unrealizedPnlMinor BigInt   @db.BigInt
  optionPremiumsMinor BigInt  @db.BigInt
  dividendsMinor     BigInt   @db.BigInt
  feesMinor          BigInt   @db.BigInt
  netPnlMinor        BigInt   @db.BigInt
  lastRecomputedAt   DateTime

  @@id([userId, symbol, baseCurrency])
  @@index([userId, symbol])
}

model TickerPnlDaily {
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id])
  symbol       String
  baseCurrency String
  date         DateTime @db.Date
  netPnlMinor        BigInt @db.BigInt
  marketValueMinor   BigInt @db.BigInt
  realizedPnlMinor   BigInt @db.BigInt
  unrealizedPnlMinor BigInt @db.BigInt

  @@id([userId, symbol, baseCurrency, date])
  @@index([userId, symbol])
}

model WheelCycle {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id])
  symbol       String
  status       String
  openedAt     DateTime
  closedAt     DateTime?
  netPnlMinor  BigInt?  @db.BigInt
  baseCurrency String
  autoDetected Boolean  @default(true)
  notes        String?

  legs WheelLeg[]

  @@index([userId, symbol])
}

model WheelLeg {
  id             String    @id @default(uuid()) @db.Uuid
  wheelCycleId   String    @db.Uuid
  wheelCycle     WheelCycle @relation(fields: [wheelCycleId], references: [id])
  kind           String
  transactionId  String?   @db.Uuid
  transaction    Transaction? @relation(fields: [transactionId], references: [id])
  linkedTransactionIds String[] @db.Uuid
  occurredAt     DateTime
  pnlMinor       BigInt?   @db.BigInt
  raw            Json?

  @@index([wheelCycleId])
  @@index([transactionId])
}

model NewsSource {
  id      String  @id @default(uuid()) @db.Uuid
  name    String
  type    String
  baseUrl String?
  enabled Boolean @default(true)
  weight  Int     @default(100)
}

model NewsItem {
  id         String   @id @default(uuid()) @db.Uuid
  provider   String
  externalId String?
  url        String
  urlHash    Bytes
  title      String
  publisher  String?
  publishedAt DateTime
  summary    String?
  raw        Json?

  symbols NewsItemSymbol[]

  @@unique([urlHash])
  @@index([publishedAt])
}

model NewsItemSymbol {
  newsItemId String @db.Uuid
  newsItem   NewsItem @relation(fields: [newsItemId], references: [id])
  symbol     String

  @@id([newsItemId, symbol])
  @@index([symbol])
}

model AlertRule {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  type      String
  symbol    String?
  config    Json
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  events AlertEvent[]

  @@index([userId, type])
  @@index([userId, symbol])
}

model AlertEvent {
  id          String   @id @default(uuid()) @db.Uuid
  alertRuleId String   @db.Uuid
  alertRule   AlertRule @relation(fields: [alertRuleId], references: [id])
  triggeredAt DateTime
  payload     Json
  deliveredAt DateTime?

  @@index([alertRuleId, triggeredAt])
}

model ExportJob {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id])
  type        String
  format      String
  params      Json
  status      String
  error       String?
  createdAt   DateTime @default(now())
  completedAt DateTime?

  file ExportFile?

  @@index([userId, createdAt])
}

model ExportFile {
  exportJobId String   @id @db.Uuid
  exportJob   ExportJob @relation(fields: [exportJobId], references: [id])
  storageKey  String
  contentType String
  sizeBytes   BigInt   @db.BigInt
  sha256      Bytes
}
