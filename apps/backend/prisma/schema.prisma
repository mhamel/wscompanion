generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  createdAt DateTime @default(now())

  deletedAt    DateTime?
  sessions     Session[]
  devices      Device[]
  entitlements Entitlement[]
  preferences  UserPreferences?
  accounts     Account[]
  transactions Transaction[]
}

model Session {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  user             User     @relation(fields: [userId], references: [id])
  refreshTokenHash String
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  revokedAt        DateTime?

  @@index([userId])
}

model Device {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id])
  platform   String
  pushToken  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastSeenAt DateTime?

  @@unique([userId, pushToken])
}

model Entitlement {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  type      String
  status    String
  startedAt DateTime @default(now())
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
}

model UserPreferences {
  userId       String   @id @db.Uuid
  user         User     @relation(fields: [userId], references: [id])
  baseCurrency String   @default("USD")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AuthOtp {
  id           String   @id @default(uuid()) @db.Uuid
  email        String
  codeSalt     String
  codeHashHex  String
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  lastAttemptAt DateTime?
  ipAddress    String?

  @@index([email, createdAt])
}

model Account {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  user              User     @relation(fields: [userId], references: [id])
  brokerConnectionId String? @db.Uuid
  externalAccountId String?
  name              String
  type              String
  baseCurrency      String   @default("USD")
  status            String
  raw               Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  positionSnapshots PositionSnapshot[]
  transactions      Transaction[]

  @@index([userId])
  @@unique([brokerConnectionId, externalAccountId])
}

model Instrument {
  id       String @id @default(uuid()) @db.Uuid
  type     String
  symbol   String?
  exchange String?
  currency String
  name     String?
  isin     String?
  raw      Json?

  optionContracts   OptionContract[]
  positionSnapshots PositionSnapshot[]
  transactions      Transaction[]

  @@index([symbol])
}

model OptionContract {
  id                   String     @id @default(uuid()) @db.Uuid
  underlyingInstrumentId String   @db.Uuid
  underlyingInstrument Instrument @relation(fields: [underlyingInstrumentId], references: [id])
  occSymbol             String    @unique
  expiry                DateTime  @db.Date
  strike                Decimal   @db.Decimal(20, 10)
  right                 String
  multiplier            Int       @default(100)
  currency              String
  raw                   Json?

  transactions Transaction[]

  @@index([underlyingInstrumentId])
}

model PositionSnapshot {
  accountId    String   @db.Uuid
  account      Account  @relation(fields: [accountId], references: [id])
  instrumentId String   @db.Uuid
  instrument   Instrument @relation(fields: [instrumentId], references: [id])

  asOf                 DateTime
  quantity             Decimal @db.Decimal(20, 10)
  avgCostAmountMinor   BigInt  @db.BigInt
  avgCostCurrency      String
  marketPriceAmountMinor BigInt? @db.BigInt
  marketPriceCurrency    String?
  marketValueAmountMinor BigInt? @db.BigInt
  marketValueCurrency    String?
  unrealizedPnlAmountMinor BigInt? @db.BigInt
  unrealizedPnlCurrency    String?
  raw                  Json?
  updatedAt            DateTime @updatedAt

  @@id([accountId, instrumentId])
  @@index([instrumentId])
}

model Transaction {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  user           User     @relation(fields: [userId], references: [id])
  accountId      String   @db.Uuid
  account        Account  @relation(fields: [accountId], references: [id])
  provider       String
  externalId     String
  executedAt     DateTime
  type           String
  instrumentId   String?  @db.Uuid
  instrument     Instrument? @relation(fields: [instrumentId], references: [id])
  optionContractId String? @db.Uuid
  optionContract   OptionContract? @relation(fields: [optionContractId], references: [id])
  quantity       Decimal? @db.Decimal(20, 10)
  priceAmountMinor BigInt? @db.BigInt
  priceCurrency  String?
  grossAmountMinor BigInt? @db.BigInt
  feesAmountMinor BigInt? @db.BigInt
  feesCurrency   String?
  notes          String?
  raw            Json?
  createdAt      DateTime @default(now())

  @@unique([provider, accountId, externalId])
  @@index([userId, executedAt])
  @@index([accountId, executedAt])
  @@index([instrumentId])
  @@index([optionContractId])
}
